<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introducing MySQL streaming with ReactPHP</title>
    <link href="../src/landing-page.v2.css" rel="stylesheet">
    <link href="../src/tailwind.min.css" rel="stylesheet">
    <link rel="alternate" type="application/atom+xml" href="../posts.atom" title="Recent blog posts" />
    <script defer data-domain="clue.engineering" src="https://plausible.io/js/script.outbound-links.js"></script>

    <meta name="description" content="Today, we&#039;re very happy to announce the immediate availability of the next major beta release of friends-of-reactphp/mysql, the async MySQL database client for ReactPHP. ðŸŽ‰  Now that v0.4.0 has been tagged and released today, let&#039;s look into why I think this is not only a major milestone for thisâ€¦">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Introducing MySQL streaming with ReactPHP">
    <meta property="og:description" content="Today, we&#039;re very happy to announce the immediate availability of the next major beta release of friends-of-reactphp/mysql, the async MySQL database client for ReactPHP. ðŸŽ‰  Now that v0.4.0 has been tagged and released today, let&#039;s look into why I think this is not only a major milestone for thisâ€¦">
    <meta property="og:url" content="https://clue.engineering/2018/introducing-reactphp-mysql">
    <meta property="og:site_name" content="clueÂ·engineering">
    <meta property="article:published_time" content="2018-09-21">
    <meta name="twitter:site" content="@another_clue">
    <meta name="twitter:creator" content="@another_clue">
</head>

<body>
    <header class="bg-gray-800">
      <div class="relative">
        <div class="flex justify-between items-center max-w-3xl mx-auto px-1 py-1">
          <div class="flex justify-start">
            <a href="../" class="text-white py-1 px-1 hover:text-blue-100">
              <strong>clue</strong>Â·engineering
            </a>
          </div>
          
          <nav class="flex justify-end items-center space-x-1 sm:space-x-8">
            <a href="../blog" class="text-base text-gray-300 hover:text-gray-200">
              Blog
            </a>
            <a href="../talks" class="text-base text-gray-300 hover:text-gray-200">
              Talks
            </a>
            <a href="../support" class="ml-8 whitespace-nowrap inline-flex items-center justify-center px-1 sm:px-4 py-1 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-500 hover:bg-blue-400">
              <span class="hidden sm:inline sm:mr-1">Professional</span> Services
            </a>
          </nav>
        </div>
      </div>
    </header>

    <section id="post">
        <div class="container">
            <article>
                <h1>Introducing MySQL streaming with ReactPHP</h1>
                <div>
                    <address>
                        <img src="../src/me.jpg" alt="Christian LÃ¼ck Portrait Photo">
                        <a href="../">Christian LÃ¼ck</a>
                    </address>
                    on <time datetime="2018-09-21">2018-09-21</time>
                    <div>
                        tagged
                        <a href="../blog#introducing-reactphp" title="Show all blog posts tagged #introducing-reactphp" rel="tag">#introducing-reactphp</a>
                        <a href="../blog#reactphp" title="Show all blog posts tagged #reactphp" rel="tag">#reactphp</a>
                        <a href="../blog#release" title="Show all blog posts tagged #release" rel="tag">#release</a>
                        <a href="../blog#mysql" title="Show all blog posts tagged #mysql" rel="tag">#mysql</a>
                        <a href="../blog#database" title="Show all blog posts tagged #database" rel="tag">#database</a>
                    </div>
                </div>

<p>Today, we're very happy to announce the immediate availability of the next major beta release of <a href="https://github.com/friends-of-reactphp/mysql">friends-of-reactphp/mysql</a>, the async MySQL database client for <a href="https://reactphp.org/">ReactPHP</a>. ðŸŽ‰</p>

<p>Now that v0.4.0 has been tagged and released today, let's look into why I think this is not only a major milestone for this project, but could also possibly be a game changer in how people use databases with ReactPHP and eventually maybe with PHP in general.</p>

<p>This post aims more for the "why" instead of "what" has changed. If you're upgrading from a previous version of this project, you may want to take a look at the <a href="https://github.com/friends-of-reactphp/mysql/releases">changelog</a> describing all the changes in greater detail. Alright, so let's dive right in.</p>

<h2 id="promise-all-the-things%21">Promise all the things!</h2>

<p>Originally, this project was maintained by <a href="https://github.com/bixuehujin">Jin Hu</a> who did an excellent job figuring out all the protocol details and building an API that can be consumed with ReactPHP. All this with just plain PHP, without requiring any custom extensions. Again, thank you!</p>

<p>Around 6 months ago, he handed over this project to <a href="https://github.com/friends-of-reactphp">@friends-of-reactphp</a> to take over maintenance and to address a number of outstanding feature requests and issues. In the meantime, we've used this as a base to successfully address some of these minor issues and released a number of minor maintenance releases. In the last months, we have prepared some major changes that we are now releasing with the v0.4.0 version.</p>

<p>One of the major changes is that its APIs now use <a href="https://github.com/reactphp/promise">promises</a> consistently as return values instead of accepting callback functions. While we understand that BC breaks may be frustrating when updating and usually try to avoid these as a consequence, we believe that it's very well worth it in this instance. To get a better understanding, let's take a look at what an average query looks like with the old API vs. the new promise-based API:</p>

<pre><code class="php">// old
$connection-&gt;query('SELECT * FROM user', function (QueryCommand $command) {
    if ($command-&gt;hasError()) {
        echo 'Error: ' . $command-&gt;getError()-&gt;getMessage() . PHP_EOL;
    } elseif (isset($command-&gt;resultRows)) {
        var_dump($command-&gt;resultRows);
    }
});

// new
$connection-&gt;query('SELECT * FROM user')-&gt;then(function (QueryResult $result) {
    var_dump($result-&gt;resultRows);
}, function (Exception $error) {
    echo 'Error: ' . $error-&gt;getMessage() . PHP_EOL;
});
</code></pre>

<p>Code-wise this may seem like a small change. However, it is a small change with a huge impact: Promises are one of the core building blocks of ReactPHP libraries. By allowing you to take advantage of promise chaining, we can significantly simplify integration with the vast ReactPHP ecosystem.</p>

<p>For example, we can use this along with ReactPHP's <a href="https://github.com/reactphp/http">HTTP server component</a> to build a very simple JSON-based HTTP API endpoint (I'll avoid the term "RESTful" here):</p>

<pre><code class="php">$server = new Server(function (ServerRequestInterface $request) use ($connection) {
    return $connection-&gt;query(
        'SELECT * FROM user WHERE id = ?',
        [$request-&gt;getQueryParams()['id'] ?? -1]
    )-&gt;then(function (QueryResult $result) {
        return new Response(
            $result-&gt;resultRows ? 200 : 404,
            array(
                'Content-Type' =&gt; 'application/json'
            ),
            json_encode($result-&gt;resultRows[0] ?? null)
        );
    });
});
</code></pre>

<p>The example output from an HTTP request could look something like this:</p>

<pre><code>$ curl -v http://localhost:8080/?id=1
â€¦
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: â€¦

{"id":"1","name":"Alice","ip":"1.2.3.4"}
</code></pre>

<h2 id="streaming-large-result-sets">Streaming large result sets</h2>

<p>The above example should be simple enough to understand how you can send any SQL statement to your MySQL database, fetch the results and then send a formatted HTTP response back for your incoming HTTP request. This works very well for smaller result sets, even when you have a larger number of concurrent incoming HTTP requests and thus may end up sending a lot of queries to your database.</p>

<p>Now let's assume instead of fetching only a single user from the database, we may want to fetch <em>all</em> users (or any large subset, such as <em>new</em> users or using any other criteria). Having millions of user records in a MySQL database is nothing particularly stressful for your database. However, if we have millions of records in our database, we probably don't want to fetch all these rows and keep them in memory in our script.</p>

<p>Enter streaming: The new version now provides a new <code>queryStream()</code> method which works very similar to the <code>query()</code> method in the previous example. However, instead of buffering the full result set in memory and then resolving the promise, it uses streams to emit <code>data</code> events for each individual row. This allows us to process result sets with thousands or millions of rows, without ever having to store all of this in memory at once.</p>

<p>Keeping the previous example, we can use this along with a <a href="https://github.com/clue/reactphp-ndjson">clue/reactphp-ndjson</a> to build a streaming, newline-delimited JSON (NDJSON) HTTP API endpoint:</p>

<pre><code class="php">$server = new Server(function (ServerRequestInterface $request) use ($connection) {
    $stream = $connection-&gt;queryStream(
        'SELECT * FROM user WHERE id &gt; ?',
        [$request-&gt;getQueryParams()['id'] ?? -1]
    );

    return new Response(
        200,
        array(
            'Content-Type' =&gt; 'application/x-ndjson'
        ),
        new \Clue\React\NDJson\Encoder($stream)
    );
});
</code></pre>

<p>The example output from an HTTP request could look something like this:</p>

<pre><code>$ curl -v http://localhost:8080/?id=0
â€¦
HTTP/1.1 200 OK
Content-Type: application/x-ndjson
Transfer-Encoding: chunked

{"id":"1","name":"Alice","ip":"1.2.3.4"}
{"id":"2","name":"Bob","ip":"20.2.3.4"}
{"id":"3","name":"Carol","ip":"30.2.3.4"}
â€¦
</code></pre>

<p>If you want to learn more about NDJSON, you may want to check out one of the <a href="https://clue.engineering/2018/introducing-reactphp-ndjson">previous blog posts</a>. Similarly, you can also use <a href="https://clue.engineering/2018/introducing-reactphp-csv">streaming CSV output</a> or pretty much any other format you prefer.</p>

<h2 id="looking-forward">Looking forward</h2>

<p>By using standard promise-based and streaming interfaces, this project can now be integrated much easier with the existing ecosystem and some of the exciting tech I've introduced in the last blog posts. For example, imagine <a href="https://clue.engineering/2018/introducing-reactphp-flux">concurrent stream processing</a> and <a href="https://clue.engineering/2018/introducing-reactphp-csv">concurrent CSV processing</a> with a MySQL query as an input stream insteadâ€¦</p>

<p>You see, this blog post is barely touching the surface of why I think this release is a major milestone. I want to keep this blog post short(er), so I'll leave this up for another post soon-ish. But first, make sure to head over to <a href="https://github.com/friends-of-reactphp/mysql">friends-of-reactphp/mysql</a> and let's celebrate this release ðŸŽ‰</p>

<p>Once again I'd like to thank <a href="https://github.com/geertvanbommel">@geertvanbommel</a>, a fellow software architect specializing in database batch processing and API development, for sponsoring large parts of this development! ðŸŽ‰ Thanks to sponsors like this, who understand the importance of open source development, I can justify spending time and focus on open source development instead of traditional paid work. If you follow my posts more regularly, I'm sure you'll recall his name. And if you plan to follow my future posts, I'm sure there are more exiting announcements to follow soonâ€¦</p>

<blockquote>
  <p>Did you know that I offer custom development services and issuing invoices for sponsorships of releases and for contributions? Contact me (@clue) for details.</p>
</blockquote>

<p>If you have any feedback or just want to reach out and say hello, I'm happy to hear back and appreciate feedback! Use the contact options in the section below and let's get in touch.</p>

<blockquote class="twitter-tweet" data-lang="de"><p lang="en" dir="ltr">Just released friends-of-reactphp/mysql v0.4.0! ðŸŽ‰ It includes many long awaited features: Promise-based APIs and streaming large result sets! Efficiently process thousands or millions of records from your <a href="https://twitter.com/MySQL?ref_src=twsrc%5Etfw">@MySQL</a> database with @ReactpPHP. <a href="https://twitter.com/hashtag/async?src=hash&amp;ref_src=twsrc%5Etfw">#async</a> <a href="https://twitter.com/hashtag/php?src=hash&amp;ref_src=twsrc%5Etfw">#php</a> <a href="https://t.co/b1Hv408RtD">https://t.co/b1Hv408RtD</a></p>&mdash; Christian LÃ¼ck (@another_clue) <a href="https://twitter.com/another_clue/status/1043161821409157129?ref_src=twsrc%5Etfw">21. September 2018</a></blockquote>
            </article>
        </div>
    </section>

    <section id="calendly">
        <div class="bg-white">
            <div class="max-w-5xl mx-auto py-16 px-4 sm:px-6 lg:px-8">
                <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden lg:grid lg:grid-cols-2 lg:gap-4">
                    <div class="pt-10 pb-12 px-6 sm:pt-16 sm:px-16 lg:py-16 lg:pr-0 xl:py-10 xl:px-10">
                        <div class="lg:self-center">
                            <h2 class="text-3xl font-extrabold text-white sm:text-4xl">
                                <span class="block">We're Here to Help!</span>
                                <span class="block text-blue-400">Let's Tackle Your Problems Together.</span>
                            </h2>
                            <p class="mt-4 text-lg leading-6 text-gray-200">
                                Did you know we provide <a href="https://clue.engineering/support" class="underline">professional support</a> for software projects?
                                Book an appointment, you pay absolutely nothing for the first consultation.
                            </p>
                            <a href="https://calendly.com/clue-engineering/getting-started" class="mt-8 bg-blue-400 hover:bg-blue-500 border border-transparent rounded-md shadow px-5 py-3 inline-flex items-center text-base font-medium text-white">Set Up a Free Call</a>
                        </div>
                    </div>
                    <div class="-mt-6 aspect-w-5 aspect-h-3 md:aspect-w-2 md:aspect-h-1">
                        <a href="https://calendly.com/clue-engineering/getting-started">
                            <img class="transform translate-x-16 translate-y-6 rounded-md object-cover object-left-top sm:translate-x-24 lg:translate-y-24 lg:translate-x-16" src="../src/2023-calendly.png" alt="calendly screenshot">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="share">
        <div class="container">
            <h3>
                <a href="#share"></a>
                We love feedback!
            </h3>
            <p>
                If you have anything to add,
                send a tweet to <a href="https://twitter.com/another_clue">@another_clue</a>.
            </p>
            <p>
                We invite you to share our blog posts with friends and colleagues.
                All our blog posts can be shared freely under the permissive
                <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY</a>
                license.
            </p>
            <p>
                <!-- Thank you! https://fontawesome.com/ (solid/envelope) -->
                <svg viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg>
                <a href="../contact">Email us</a> if you think we should be working together on interesting projects.
            </p>
        </div>
    </section>

    <footer class="bg-gray-800">
      <div class="max-w-7xl mx-auto py-12 px-4 overflow-hidden sm:px-6 lg:px-8">
        <nav class="-mx-5 -my-2 flex flex-wrap justify-center" aria-label="Footer">
          <div class="px-5 py-2">
            <a href="../" class="text-base text-gray-400 hover:text-gray-300">
              Home
            </a>
          </div>

          <div class="px-5 py-2">
            <a href="../support" class="text-base text-gray-400 hover:text-gray-300">
              Services
            </a>
          </div>

          <div class="px-5 py-2">
            <a href="../blog" class="text-base text-gray-400 hover:text-gray-300">
              Blog
            </a>
          </div>

          <div class="px-5 py-2">
            <a href="../talks" class="text-base text-gray-400 hover:text-gray-300">
              Talks
            </a>
          </div>

          <div class="px-5 py-2">
            <a href="../contact" class="text-base text-gray-400 hover:text-gray-300">
              Contact
            </a>
          </div>


          <div class="px-5 py-2">
            <a href="../contact#imprint" class="text-base text-gray-400 hover:text-gray-300">
              Imprint
            </a>
          </div>
        </nav>
        <div class="mt-8 flex justify-center space-x-6">
          <a href="https://twitter.com/another_clue" title="@another_clue on Twitter" class="text-gray-400 hover:text-gray-300">
            <span class="sr-only">Twitter</span>
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" />
            </svg>
          </a>
    
          <a href="https://github.com/clue" title="@clue on GitHub" class="text-gray-400 hover:text-gray-300">
            <span class="sr-only">GitHub</span>
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
            </svg>
          </a>
        </div>
      </div>
    </footer>
</body>
</html>
